@model Emina.Models.Enquete

@{
    ViewBag.Title = "Edit Questions";
}



<h2>Edit Questions</h2>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
@using (Html.BeginForm("ParseQuestionsEdit", "EnqueteBuilder", FormMethod.Post)) {
    <table id="QuestionTable">
        <tr>
            <th>
                #
            </th>
            <th>
                Question Text
            </th>
            <th>
                Question Type
            </th>
            <th>
                Default Next Question
            </th>
            <th>

            </th>
        </tr>
        @{
            var count = 1;   
        }
        @foreach (var question in Model.Questions)
        {
            var Text = "Question_" + count + "_Text";
            var Type = "Question_" + count + "_Type";
            var Next = "Question_" + count + "_Next";
            var Number = "Question_" + count + "_Number";
            var Row = "Question_" + count + "_Row";
            
            <tr id="@Row">
                <td id="@Number">
                    @question.QuestionNumber
                </td>
                <td>
                    <input type="text" name="@Text" id="@Text" value="@question.Text"/>
                </td>
                <td>
                    <select id="@Type" name="@Type">
                            @foreach (var QuestionType in ViewBag.QuestionTypes)
                            {
                                if (question.Type == QuestionType)
                                {
                                    <option selected="selected" value="@QuestionType">
                                        @QuestionType
                                    </option>
                                }
                                else 
                                {  
                                    <option value="@QuestionType">
                                        @QuestionType
                                    </option>
                                }
                            }
                    </select>
                </td>
                <td>
                    <select id="@Next" name="@Next">
                            <option value="null">
                                None
                            </option>
                            @foreach (var q in Model.Questions.Where(quest => quest.QuestionID != question.QuestionID))
                            {
                                <option value="@q.QuestionID">
                                    @q.QuestionNumber
                                </option>
                            }
                    </select>
                </td>
                <td>
                    <a href="javascript:deleteRow(@count)">
                        Delete
                    </a>
                </td>
            </tr>
            count++;
        }
        <tr id="addQuestionRow">
            <td>
                <h3>
                    <a href="javascript:addQuestionRow()">
                        Add Question
                    </a>
                </h3>
            </td>
        </tr>
    </table>
    <input type="hidden" value="0" id="questionCount" name="questionCount" />
}

<script type="text/javascript">
    var questionTypes = ["Open", "MultipleChoice", "Checkbox", "Stars", "Grade", "Binary", "FuzzyBinary"];
    var questionCount = 1;
    var questions = new Array();

    $(document).ready(function () {
        @foreach(var question in Model.Questions){
            @Html.Raw(
            "       tmp = new Object(); \n"+
            "       tmp.text = \""+question.Text+"\";\n"+
            "       tmp.type = \""+question.Type+"\";\n"
            );

            if (question.NextQuestion != null)
            {
                @Html.Raw("       tmp.next = " + question.NextQuestion.QuestionID+";\n")
                @Html.Raw("       tmp.nextNumber = " + question.NextQuestion.QuestionNumber+";\n")
                @Html.Raw("       $(\"#Question_\"+questionCount+\"_Type\").val(\"" + question.NextQuestion.QuestionNumber+"\");\n");
            }
            else
            {
                @Html.Raw("       tmp.next = null;\n");
                @Html.Raw("       $(\"#Question_\" + questionCount + \"_Type\").val(\"None\");\n");
            }
            @Html.Raw("       questions[questionCount++] = tmp;\n");
        }
        $("#questionCount").val(questionCount);
    });

    function addQuestionRow() {
        var row = "<tr id=\"Question_" + questionCount + "_Row\"><td id=\"Question_" + questionCount + "_Number\">" + questionCount + "</td><td><input id=\"Question_" + questionCount + "_Text\" type=\"text\" value=\"\" name=\"Question_" + questionCount + "_Text\"></td><td><select id=\"Question_" + questionCount + "_Type\" name=\"Question_" + questionCount + "_Type\"><option> Open </option><option> MultipleChoice </option><option> Checkbox </option><option> Stars </option><option> Grade </option><option> Binary </option><option> FuzzyBinary </option></select></td><td><select id=\"Question_" + questionCount + "_Next\" name=\"Question_" + questionCount + "_Next\"><option>None</option>";
        for (a = 0; a < questionCount-1; ++a) {
            row += "<option>" + (a + 1) + "</option>";
        }
        for (a = 1; a < questions.length; ++a) {
            $("#Question_" + a + "_Next").append("<option value=\""+questionCount+"\">" + questionCount + "</option>");
        }
        row += "</select></td><td><a href=\"javascript:deleteRow("+questionCount+")\">Delete</a></td></tr>";
        $("#addQuestionRow").before(row);
        
        var tmp = new Object();
        tmp.text = "";
        tmp.type = "Open";
        tmp.next = null;
        questions[questionCount++] = tmp;
        $("#questionCount").val(questionCount);
    }

    function deleteRow(number) {
        $("#Question_" + number + "_Row").remove();
        if (number != questionCount - 1) {
            for (a = number; a < questionCount - 1; ++a) {
                alert(a + " becomes " + (a + 1));
                questions[a] = questions[a + 1];
            }
        } else {
            
        }
        questionCount--;
        $("#questionCount").val(questionCount);
    }

</script>
<div>
    @Html.ActionLink("Back to List", "Index")
</div>